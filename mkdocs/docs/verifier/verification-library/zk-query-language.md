// [ ] TODO: update example of the query language when new JS library is available

# Query Language

The <a href="https://docs.iden3.io/protocol/main-circuits/#credentialatomicquerysig" target="_blank">`Atomic Query Signature Circuit`</a> and <a href="https://docs.iden3.io/protocol/main-circuits/#credentialatomicquerymtp" target="_blank">`Atomic Query MTP`</a> circuits have been designed as generic circuits to do the zk verification based on users' claims. 

The Query Language sits on top of these circuits to provide a simple way for developers to design customised authentication requirements based on someone's claims. As long as the user holds a claim of a specific type, the Verifier can design a query related to the claim based on 5 operators, for example:  

- Must be an admin inside PolygonDAO to vote for a specific proposal - `equals` (operator 1).
- Must have been born before 2000-01-01 to access an adult content website - `less-than` (operator 2).
- Must have a monthly salary greater than $1000 to get a loan - `greater-than` (operator 3).
- Must be an admin or an hacker of PolygonDAO to enter a platform - `Ã¬n` (operator 4).
- Must not be a resident of a country in the list of blacklisted countries to operate on an exchange - `not-in` (operator 5).

The query is designed by the Verifier and presented to the user via a QR Code. Starting from the proof generated by the user as a response to the query, the Verifier is easily able to check if the query is satisfied or not. The Verifier **doesn't get access to any user's data**.

The Query Language follows the same rules whether the verification is implemented on-chain or off-chain, while the syntax to define these is a bit different. For each of the query presented above, both the on-chain and off-chain way of designing will now be defined. 

> The entire scripts to set a query are available here: [off-chain verification](./verifier-set-up.md), [on-chain verification](../on-chain-verification/overview.md)

### Equals - Operator 1

**Claim Schema**

The ProofOfPersonhood claim encodes whether a user has been verified as a unique person or not. Here's the [Claim Schema](https://s3.eu-west-1.amazonaws.com/polygonid-schemas/9fe70c03-ea4a-432c-a64d-ee8783549713.json-ld) defined via a JSON-LD file.

<div align="center">
<img src= "../../../imgs/query-proof-of-personhood.png" align="center" width="500"/>
</div>
<br>

**Query**

When presented with this query, the user must prove that he/she is an Admin of Polygon DAO.

=== "off-chain"

    ```ts
    const proofRequest: protocol.ZKPRequest = {
      id: 1, // request id
      circuit_id: 'credentialAtomicQuerySig',
      rules: {
        query: {
          allowedIssuers: ['*'], // any issuer is valid
          schema: {
            type: 'ProofOfPersonhood',
            url: 'https://s3.eu-west-1.amazonaws.com/polygonid-schemas/9fe70c03-ea4a-432c-a64d-ee8783549713.json-ld', // extracted from PID platform
          },
          req: {
            VerifiedPerson: {
              $eq: 1, // the value must be 1 = true
            },
          },
        },
      },
    };
    ```

=== "on-chain"

    ```ts
    const schemaHash = "bc17cbe68b8dd1868281dd1f23f823e1" // extracted from PID Platform

    const schemaEnd = fromLittleEndian(hexToBytes(schemaHash))

    const circuitId = "credentialAtomicQuerySig";

    const query = {
    schema: ethers.BigNumber.from(schemaEnd),
    slotIndex: 2, // slotIndex2 indicates the value stored as Attribute 1 inside the claim
    operator: 1,
    value: [1, ...new Array(63).fill(0).map(i => 0)], // the value must be 1 = true
    circuitId,
    };
    ```
    ```json
    // Corresponding QR Code
    {  
        "id":"c811849d-6bfb-4d85-936e-3d9759c7f105",
        "typ":"application/iden3comm-plain-json",
        "type":"https://iden3-communication.io/proofs/1.0/contract-invoke-request",
        "body":{
            "transaction_data":{
                "contract_address":"0x53baE2308366cd5799B2A95539Ec9E2F5d6f1e0c",  //replace it with your contract address
                "method_id":"b68967e2",
                "chain_id":80001,
                "network":"polygon-mumbai"
                },
            "reason":"airdrop participation",
            "scope":[{
                "id":1,
                "circuit_id":"credentialAtomicQuerySig",
                "rules":{
                    "query":{
                        "allowed_issuers":["*"],
                        "req":{ 
                            "VerifiedPerson":{
                                "$eq":1
                                }
                            },
                        "schema":{
                                "url":"https://s3.eu-west-1.amazonaws.com/polygonid-schemas/9fe70c03-ea4a-432c-a64d-ee8783549713.json-ld", 
                                "type":"ProofOfPersonhood" 
                                }
                            }
                        }
                    }]
                }
    }
    ```

### Less-than - Operator 2

**Claim Schema**

The AgeCredential claim encodes the date of birth of the claim subject. Here's the [Claim Schema](https://s3.eu-west-1.amazonaws.com/polygonid-schemas/9b1c05f4-7fb6-4792-abe3-d1ddbd9a9609.json-ld) defined via a JSON-LD file.

<div align="center">
<img src= "../../../imgs/query2.png" align="center" width="500"/>
</div>
<br>

**Query**

When presented with this query, the user must prove that he/she has been born before 2001/01/01.

=== "off-chain"

    ```ts
      const proofRequest: protocol.ZKPRequest  = {
        id: 1, // request id
        circuit_id: 'credentialAtomicQuerySig',
        rules: {
          query: {
          allowedIssuers: ['*'], // any issuer is valid
          schema: {
            type: 'AgeCredential',
            url: 'https://s3.eu-west-1.amazonaws.com/polygonid-schemas/9b1c05f4-7fb6-4792-abe3-d1ddbd9a9609.json-ld', // extracted from PID platform
          },
          req: {
            dateOfBirth: {
            $lt: 20010101, // the dateofbirth must be prior to 2001/01/01
            },
          },
          },
        },
        };
    ```


=== "on-chain"

    ```ts
    const schemaHash = "f03ac39aa54a5a2770a30f17d8042507" // extracted from PID Platform

    const schemaEnd = fromLittleEndian(hexToBytes(schemaHash))

    const circuitId = "credentialAtomicQuerySig";

    const query = {
    schema: ethers.BigNumber.from(schemaEnd),
    slotIndex: 2, // slotIndex2 indicates the value stored as Attribute 1 inside the claim
    operator: 2,
    value: [20010101, ...new Array(63).fill(0).map(i => 0)],
    circuitId,
    };
    ```
    ```json
    // Corresponding QR Code
    {  
        "id":"c811849d-6bfb-4d85-936e-3d9759c7f105",
        "typ":"application/iden3comm-plain-json",
        "type":"https://iden3-communication.io/proofs/1.0/contract-invoke-request",
        "body":{
            "transaction_data":{
                "contract_address":"0xCe03F5d970b0BA0e5d2b1C82160dEa1b05191C73",  //replace it with your contract address
                "method_id":"b68967e2",
                "chain_id":80001,
                "network":"polygon-mumbai"
                },
            "reason":"airdrop participation",
            "scope":[{
                "id":1,
                "circuit_id":"credentialAtomicQuerySig",
                "rules":{
                    "query":{
                        "allowed_issuers":["*"],
                        "req":{ 
                            "dateOfBirth":{
                                "$lt":20010101
                                }
                            },
                        "schema":{
                                "url":"https://s3.eu-west-1.amazonaws.com/polygonid-schemas/9b1c05f4-7fb6-4792-abe3-d1ddbd9a9609.json-ld", 
                                "type":"AgeCredential" 
                                }
                            }
                        }
                    }]
                }
    }
    ```

### Greater-than - Operator 3

**Claim Schema**

The EmployeeData claim encodes two attributes:

- the starting date of employment
- the monthly salary of an employee 

Here's the [Claim Schema](https://s3.eu-west-1.amazonaws.com/polygonid-schemas/ccbec58c-7f05-4cd3-994c-614b1f066e1c.json-ld) defined via a JSON-LD file.

<div align="center">
<img src= "../../../imgs/query3.png" align="center" width="500"/>
</div>
<br>

**Query**

When presented with this query, the user must prove that his/her monthly salary is greater than $1000.

=== "off-chain"

    ```ts
    const proofRequest: protocol.ZKPRequest = {
      id: 1, // request id
      circuit_id: 'credentialAtomicQuerySig',
      rules: {
        query: {
          allowedIssuers: ['*'], // any issuer is valid
          schema: {
            type: 'EmployeeData',
            url: 'https://s3.eu-west-1.amazonaws.com/polygonid-schemas/ccbec58c-7f05-4cd3-994c-614b1f066e1c.json-ld', // extracted from PID platform
          },
          req: {
            MonthlySalary: {
              $gt: 1000, // the role must be 3 = Admin
            },
          },
        },
      },
    };
    ```


=== "on-chain"

    ```ts
    const schemaHash = "f4cfcaa00dbc2954ded157c8e25792ee"  // extracted from PID platform

    const schemaEnd = fromLittleEndian(hexToBytes(schemaHash))

    const circuitId = "credentialAtomicQuerySig";

    const query = {
    schema: ethers.BigNumber.from(schemaEnd),
    slotIndex: 3,  // slotIndex3 indicates the value stored as Attribute 2 inside the claim
    operator: 3,
    value: [1000, ...new Array(63).fill(0).map(i => 0)],
    circuitId,
    };
    ```
    ```json
    // Corresponding QR Code
    {  
        "id":"c811849d-6bfb-4d85-936e-3d9759c7f105",
        "typ":"application/iden3comm-plain-json",
        "type":"https://iden3-communication.io/proofs/1.0/contract-invoke-request",
        "body":{
            "transaction_data":{
                "contract_address":"0x114cdF17C054782BbFB6F182B3502f1Ea2973dbd",  //replace it with your contract address
                "method_id":"b68967e2",
                "chain_id":80001,
                "network":"polygon-mumbai"
                },
            "reason":"airdrop participation",
            "scope":[{
                "id":1,
                "circuit_id":"credentialAtomicQuerySig",
                "rules":{
                    "query":{
                        "allowed_issuers":["*"],
                        "req":{ 
                            "MonthlySalary":{
                                "$gt":1000
                                }
                            },
                        "schema":{
                                "url":"https://s3.eu-west-1.amazonaws.com/polygonid-schemas/ccbec58c-7f05-4cd3-994c-614b1f066e1c.json-ld", 
                                "type":"EmployeeData" 
                                }
                            }
                        }
                    }]
                }
    }
    ```

> Note that the slotIndex queried inside the on-chain example is no longer 2. That's because this claim schema comprises of two attributes and the query refers to the second atttribute, therefore the value is put inside of slotIndex 3, according to claim structure.

### In - Operator 4 

**Claim Schema**

The PolygonDAOMember claim encodes the role of a member inside Polygon DAO. Each role is defined by a number. Here's the [Claim Schema](https://s3.eu-west-1.amazonaws.com/polygonid-schemas/edf4e0da-d023-42cd-b627-0717566382b1.json-ld) defined via a JSON-LD file.

<div align="center">
<img src= "../../../imgs/query1.png" align="center" width="500"/>
</div>
<br>

**Query**

When presented with this query, the user must prove that he/she is either an Admin or an Hacker of Polygon DAO.

=== "off-chain"

    ```ts
    const proofRequest: protocol.ZKPRequest = {
      id: 1, // request id
      circuit_id: 'credentialAtomicQuerySig',
      rules: {
        query: {
          allowedIssuers: ['*'], // any issuer is valid
          schema: {
            type: 'PolygonDAOMember',
            url: 'https://s3.eu-west-1.amazonaws.com/polygonid-schemas/edf4e0da-d023-42cd-b627-0717566382b1.json-ld', // extracted from PID platform
          },
          req: {
            Role: {
              $in: [2, 3], // the role must either 3 = Admin or 2 = Hacker
            },
          },
        },
      },
    };
    ```


=== "on-chain"

    ```ts
    const schemaHash = "c6cd9c4ea01df58ef5386515a3e3acc0" // extracted from PID Platform

    const schemaEnd = fromLittleEndian(hexToBytes(schemaHash))

    const circuitId = "credentialAtomicQuerySig";

    const query = {
    schema: ethers.BigNumber.from(schemaEnd),
    slotIndex: 2, // slotIndex2 indicates the value stored as Attribute 1 inside the claim
    operator: 4,
    value: [2, 3, ...new Array(62).fill(0).map(i => 0)],
    circuitId,
    };
    ```
    ```json
    // Corresponding QR Code
    {  
        "id":"c811849d-6bfb-4d85-936e-3d9759c7f105",
        "typ":"application/iden3comm-plain-json",
        "type":"https://iden3-communication.io/proofs/1.0/contract-invoke-request",
        "body":{
            "transaction_data":{
                "contract_address":"0xB2858515075057EF5a91e872ef4adB11ae639536",  //replace it with your contract address
                "method_id":"b68967e2",
                "chain_id":80001,
                "network":"polygon-mumbai"
                },
            "reason":"airdrop participation",
            "scope":[{
                "id":1,
                "circuit_id":"credentialAtomicQuerySig",
                "rules":{
                    "query":{
                        "allowed_issuers":["*"],
                        "req":{ 
                            "Role":{
                                "$in":[2, 3]
                                }
                            },
                        "schema":{
                                "url":"https://s3.eu-west-1.amazonaws.com/polygonid-schemas/edf4e0da-d023-42cd-b627-0717566382b1.json-ld", 
                                "type":"PolygonDAOMember" 
                                }
                            }
                        }
                    }]
                }
    }
    ```

### Not-in - Operator 5

**Claim Schema**

The Residence claim encodes the Country of Residence of the claim subject according to the [ISO Standard](https://en.wikipedia.org/wiki/List_of_ISO_3166_country_codes)

Here's the [Claim Schema](https://s3.eu-west-1.amazonaws.com/polygonid-schemas/a57232c5-b9b8-41b6-b6bc-7fbf10c5046c.json-ld) defined via a JSON-LD file.

<div align="center">
<img src= "../../../imgs/query5.png" align="center" width="500"/>
</div>
<br>

**Query**

When presented with this query, the user must prove that he/she is not resident of the countries `840, 120, 340, 509` identified following the ISO Standard.

=== "off-chain"

    ```ts
    const proofRequest: protocol.ZKPRequest = {
      id: 1, // request id
      circuit_id: 'credentialAtomicQuerySig',
      rules: {
        query: {
          allowedIssuers: ['*'], // any issuer is valid
          schema: {
            type: 'Residence',
            url: 'https://s3.eu-west-1.amazonaws.com/polygonid-schemas/a57232c5-b9b8-41b6-b6bc-7fbf10c5046c.json-ld', // extracted from PID platform
          },
          req: {
            CountryOfResidence: {
              $nin: [840, 120, 340, 509], // these 4 code represent countries included in the blacklist of the verifier
            },
          },
        },
      },
    };
    ```


=== "on-chain"

    ```ts
    const schemaHash = "27dca47f1a53c4738850d627e2c4bd48"

    const schemaEnd = fromLittleEndian(hexToBytes(schemaHash))

    const circuitId = "credentialAtomicQuerySig";

    const query = {
    schema: ethers.BigNumber.from(schemaEnd),
    slotIndex: 2, // slotIndex2 indicates the value stored as Attribute 1 inside the claim
    operator: 5,
    value: [840, 120, 340, 509, ...new Array(60).fill(0).map(i => 0)],
    circuitId,
    };
    ```
    ```json
    // Corresponding QR Code
    {  
        "id":"c811849d-6bfb-4d85-936e-3d9759c7f105",
        "typ":"application/iden3comm-plain-json",
        "type":"https://iden3-communication.io/proofs/1.0/contract-invoke-request",
        "body":{
            "transaction_data":{
                "contract_address":"0x58899aB4176e71d779c25C901eBc5F921211E0C2", //replace it with your contract address
                "method_id":"b68967e2",
                "chain_id":80001,
                "network":"polygon-mumbai"
                },
            "reason":"airdrop participation",
            "scope":[{
                "id":1,
                "circuit_id":"credentialAtomicQuerySig",
                "rules":{
                    "query":{
                        "allowed_issuers":["*"],
                        "req":{ 
                            "CountryOfResidence":{
                                "$nin":[840, 120, 340, 509]
                                }
                            },
                        "schema":{
                                "url":"https://s3.eu-west-1.amazonaws.com/polygonid-schemas/a57232c5-b9b8-41b6-b6bc-7fbf10c5046c.json-ld", 
                                "type":"Residence" 
                                }
                            }
                        }
                    }]
                }
    }
    ```  

> When designing a query, filling the `req` field is not mandatory. For instance, a platform can just ask the user to have an AgeCredential claim as a way to identify unique humans without any requirements related to the date of birth. In that case, the Veriifer should simply not fill the `req` field inside the query.